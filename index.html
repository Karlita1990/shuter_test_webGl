<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D –ë—Ä–æ–¥–∏–ª–∫–∞-—Å—Ç—Ä—ñ–ª—è–ª–∫–∞ (–ú–æ–±—ñ–ª—å–Ω–∞, –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∞)</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background: #000;
            touch-action: none; /* –ì–ª–æ–±–∞–ª—å–Ω–æ –∑–∞–±–æ—Ä–æ–Ω—è—î–º–æ —Å–∫—Ä–æ–ª */
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        /* –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∑–∞—î–º–æ–¥—ñ—é –∑ –º–æ–¥–∞–ª—å–Ω–∏–º –≤—ñ–∫–Ω–æ–º */
        body.modal-open {
            touch-action: manipulation !important;
            overflow: hidden !important;
        }
        
        body.modal-open #touch-zone-left,
        body.modal-open #touch-zone-right,
        body.modal-open #fire-button,
        body.modal-open #interact-button {
            pointer-events: none; /* –í–∏–º–∏–∫–∞—î–º–æ —ñ–≥—Ä–æ–≤—ñ –∫–Ω–æ–ø–∫–∏ –ø—ñ–¥ —á–∞—Å –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ */
        }
        
        /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞ –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—è */
        @media (orientation: portrait) {
            #rotate-warning {
                display: flex !important;
            }
        }
        
        #rotate-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            color: white;
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-size: 24px;
            text-align: center;
            padding: 20px;
        }
        
        #info-panel {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #00ff00;
            z-index: 10;
            display: flex;
            justify-content: space-around;
            backdrop-filter: blur(5px);
            font-size: 16px;
            pointer-events: none;
        }
        
        #info-panel div {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        #info-panel .value {
            color: #00ff00;
            font-weight: bold;
            font-size: 18px;
        }
        
        #crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 50%;
            z-index: 5;
            pointer-events: none;
        }
        
        #level-name {
            position: absolute;
            top: 70px;
            left: 10px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            color: #ffaa00;
            padding: 8px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            border: 1px solid #ffaa00;
            z-index: 10;
            text-align: center;
            backdrop-filter: blur(5px);
            pointer-events: none;
        }
        
        /* –°–µ–Ω—Å–æ—Ä–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è */
        #touch-zone-left {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 150px;
            height: 150px;
            background: rgba(255,255,255,0.15);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 75px;
            z-index: 20;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            text-transform: uppercase;
            touch-action: none;
        }
        
        #touch-zone-right {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 150px;
            height: 150px;
            background: rgba(255,255,255,0.15);
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 75px;
            z-index: 20;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            text-transform: uppercase;
            touch-action: none;
        }
        
        #fire-button {
            position: absolute;
            bottom: 190px;
            right: 40px;
            width: 80px;
            height: 80px;
            background: rgba(255,0,0,0.6);
            border: 4px solid #ff0000;
            border-radius: 40px;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 20px rgba(255,0,0,0.5);
            touch-action: none;
        }
        
        #interact-button {
            position: absolute;
            bottom: 190px;
            left: 40px;
            width: 80px;
            height: 80px;
            background: rgba(0,255,0,0.4);
            border: 4px solid #00ff00;
            border-radius: 40px;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 20px rgba(0,255,0,0.3);
            touch-action: none;
        }
        
        #joystick-left, #joystick-right {
            position: absolute;
            width: 150px;
            height: 150px;
            z-index: 21;
            pointer-events: none;
        }
        
        #joystick-left {
            bottom: 20px;
            left: 20px;
        }
        
        #joystick-right {
            bottom: 20px;
            right: 20px;
        }
        
        .joystick-knob {
            position: absolute;
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.6);
            border-radius: 30px;
            top: 45px;
            left: 45px;
            border: 3px solid white;
            transition: transform 0.05s;
            pointer-events: none;
        }
        
        #trigger-indicator {
            position: absolute;
            bottom: 280px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,255,0,0.8);
            color: black;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid white;
            z-index: 30;
            display: none;
            backdrop-filter: blur(5px);
            white-space: nowrap;
            animation: pulse 1s infinite;
            pointer-events: none;
        }
        
        @keyframes pulse {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.1); }
            100% { transform: translateX(-50%) scale(1); }
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ - –í–ò–ü–†–ê–í–õ–ï–ù–û */
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 30px;
            border-radius: 20px;
            border: 3px solid #00ffff;
            z-index: 1000;
            display: none;
            text-align: center;
            min-width: 300px;
            max-width: 90%;
            box-shadow: 0 0 50px rgba(0,255,255,0.5);
            backdrop-filter: blur(10px);
            /* –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∑–∞—î–º–æ–¥—ñ—é */
            touch-action: manipulation;
            -webkit-user-select: text;
            user-select: text;
        }
        
        .modal h2 {
            color: #00ffff;
            margin-top: 0;
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .modal p {
            font-size: 20px;
            margin-bottom: 20px;
        }
        
        /* –ü–æ–ª–µ –≤–≤–µ–¥–µ–Ω–Ω—è - –º–∞—î –±—É—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω–∏–º */
        .modal input {
            padding: 15px;
            font-size: 20px;
            width: 100%;
            margin: 15px 0 25px;
            border-radius: 12px;
            border: 2px solid #00ffff;
            background: #222;
            color: white;
            -webkit-appearance: none;
            appearance: none;
            box-sizing: border-box;
            /* –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–∑–∞—î–º–æ–¥—ñ—é */
            pointer-events: auto;
            touch-action: manipulation;
            -webkit-user-select: text;
            user-select: text;
        }
        
        .modal input:focus {
            outline: none;
            border-color: #ffaa00;
            background: #333;
        }
        
        .modal button {
            padding: 15px 40px;
            font-size: 22px;
            background: #00ffff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            color: black;
            font-weight: bold;
            margin: 5px;
            min-width: 150px;
            pointer-events: auto;
            touch-action: manipulation;
        }
        
        .modal button:active {
            background: #00aaaa;
            transform: scale(0.95);
        }
        
        .modal .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 40px;
            cursor: pointer;
            color: #ff0000;
            padding: 0 15px;
            pointer-events: auto;
            touch-action: manipulation;
        }
        
        .modal .close-btn:active {
            color: #ff6666;
            transform: scale(1.2);
        }
        
        #modal-result {
            margin-top: 15px;
            font-size: 18px;
            min-height: 30px;
        }
        
        #damage-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,0,0,0);
            pointer-events: none;
            z-index: 15;
            transition: background 0.2s;
        }
        
        /* –ó–∞—Ç–µ–º–Ω–µ–Ω–Ω—è —Ñ–æ–Ω—É –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç–æ–º—É –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ */
        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 999;
            display: none;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="rotate-warning">
        <svg viewBox="0 0 100 100" width="100" height="100">
            <rect x="20" y="30" width="60" height="40" rx="5" fill="none" stroke="white" stroke-width="3"/>
            <circle cx="50" cy="50" r="5" fill="white"/>
            <path d="M35 20 L50 5 L65 20" stroke="white" stroke-width="3" fill="none"/>
        </svg>
        <p>–ü–æ–≤–µ—Ä–Ω—ñ—Ç—å –ø—Ä–∏—Å—Ç—Ä—ñ–π<br>—É –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–µ –ø–æ–ª–æ–∂–µ–Ω–Ω—è</p>
    </div>

    <div id="info-panel">
        <div>‚ù§Ô∏è <span id="health" class="value">100</span></div>
        <div>‚≠ê <span id="score" class="value">0</span></div>
        <div>üî´ <span id="ammo" class="value">30</span></div>
        <div>üó∫Ô∏è <span id="level-display" class="value">1/3</span></div>
    </div>
    
    <div id="level-name">–ú–Ü–°–¨–ö–ê –ó–ê–ë–£–î–û–í–ê</div>
    <div id="crosshair"></div>
    
    <!-- –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç—Ä–∏–≥–µ—Ä–∞ -->
    <div id="trigger-indicator">üëÜ –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –ó–ï–õ–ï–ù–£ –∫–Ω–æ–ø–∫—É</div>
    
    <!-- –°–µ–Ω—Å–æ—Ä–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è -->
    <div id="touch-zone-left">
        <span>‚Üê –†–£–• ‚Üí</span>
    </div>
    <div id="touch-zone-right">
        <span>‚Üê –û–ì–õ–Ø–î ‚Üí</span>
    </div>
    <div id="fire-button">üî´</div>
    <div id="interact-button">üëÜ</div>
    
    <div id="joystick-left">
        <div class="joystick-knob" id="left-knob"></div>
    </div>
    <div id="joystick-right">
        <div class="joystick-knob" id="right-knob"></div>
    </div>
    
    <div id="damage-overlay"></div>
    <div class="modal-backdrop" id="modal-backdrop"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ (–í–ò–ü–†–ê–í–õ–ï–ù–û) -->
    <div id="task-modal" class="modal">
        <span class="close-btn" id="modal-close-btn">&times;</span>
        <h2 id="modal-title">–¢–µ—Å—Ç–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è</h2>
        <p id="modal-question">2 + 2 = ?</p>
        <input type="number" id="modal-answer" placeholder="–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å" inputmode="numeric" autocomplete="off">
        <br>
        <button id="modal-submit-btn">–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>
        <p id="modal-result" style="margin-top: 10px;"></p>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.128.0/build/three.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å—Ü–µ–Ω–∏ ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 30, 100);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 15);
        camera.rotation.order = 'YXZ';

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // --- –û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è ---
        const ambientLight = new THREE.AmbientLight(0x404060);
        scene.add(ambientLight);

        const sunLight = new THREE.DirectionalLight(0xffffff, 1);
        sunLight.position.set(50, 50, 50);
        sunLight.castShadow = true;
        scene.add(sunLight);

        // --- –ó–º—ñ–Ω–Ω—ñ —Å—Ç–∞–Ω—É ---
        let player = {
            health: 100,
            score: 0,
            ammo: 30,
            level: 1,
            maxLevel: 3,
            nearTrigger: null
        };

        const bullets = [];
        const enemies = [];
        
        // –°–µ–Ω—Å–æ—Ä–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
        let leftTouchId = null;
        let rightTouchId = null;
        let leftStartPos = { x: 0, y: 0 };
        let rightStartPos = { x: 0, y: 0 };
        let leftCurrentPos = { x: 0, y: 0 };
        let rightCurrentPos = { x: 0, y: 0 };
        
        const moveDirection = new THREE.Vector3(0, 0, 0);
        
        // –ï–ª–µ–º–µ–Ω—Ç–∏ UI
        const leftZone = document.getElementById('touch-zone-left');
        const rightZone = document.getElementById('touch-zone-right');
        const fireButton = document.getElementById('fire-button');
        const interactButton = document.getElementById('interact-button');
        const leftKnob = document.getElementById('left-knob');
        const rightKnob = document.getElementById('right-knob');
        const damageOverlay = document.getElementById('damage-overlay');
        const triggerIndicator = document.getElementById('trigger-indicator');
        
        // –ï–ª–µ–º–µ–Ω—Ç–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        const modal = document.getElementById('task-modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalSubmitBtn = document.getElementById('modal-submit-btn');
        const modalAnswer = document.getElementById('modal-answer');
        const modalQuestion = document.getElementById('modal-question');
        const modalResult = document.getElementById('modal-result');
        
        let currentTaskId = 0;
        let activeTrigger = null;

        // --- –§—É–Ω–∫—Ü—ñ—ó –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ ---
        function openModal() {
            modal.style.display = 'block';
            modalBackdrop.style.display = 'block';
            document.body.classList.add('modal-open');
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª—ñ –≤–≤–µ–¥–µ–Ω–Ω—è –∑ –Ω–µ–≤–µ–ª–∏–∫–æ—é –∑–∞—Ç—Ä–∏–º–∫–æ—é
            setTimeout(() => {
                modalAnswer.focus();
            }, 300);
        }
        
        function closeModal() {
            modal.style.display = 'none';
            modalBackdrop.style.display = 'none';
            document.body.classList.remove('modal-open');
            modalAnswer.value = '';
            modalResult.textContent = '';
            modalResult.style.color = '';
        }
        
        function checkAnswer() {
            const answer = modalAnswer.value.trim();
            
            const correctAnswers = ['4', '6', '8'];
            const isCorrect = (answer === correctAnswers[currentTaskId]);
            
            if (isCorrect) {
                modalResult.style.color = '#00ff00';
                modalResult.textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! +10 –±–∞–ª—ñ–≤';
                player.score += 10;
                updateUI();
                
                if (activeTrigger) {
                    scene.remove(activeTrigger);
                    activeTrigger = null;
                    player.nearTrigger = null;
                    triggerIndicator.style.display = 'none';
                }
                
                setTimeout(closeModal, 1000);
            } else {
                modalResult.style.color = '#ff0000';
                modalResult.textContent = '–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ!';
            }
        }
        
        // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞
        modalCloseBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeModal();
        });
        
        modalCloseBtn.addEventListener('click', (e) => {
            e.preventDefault();
            closeModal();
        });
        
        modalSubmitBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            checkAnswer();
        });
        
        modalSubmitBtn.addEventListener('click', (e) => {
            e.preventDefault();
            checkAnswer();
        });
        
        // –î–æ–∑–≤–æ–ª—è—î–º–æ –≤–≤–µ–¥–µ–Ω–Ω—è –≤ –ø–æ–ª—ñ
        modalAnswer.addEventListener('touchstart', (e) => {
            e.stopPropagation();
        });
        
        modalAnswer.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        modalAnswer.addEventListener('focus', (e) => {
            e.stopPropagation();
        });

        // --- –°–µ–Ω—Å–æ—Ä–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è ---
        function handleTouchStart(e) {
            if (document.body.classList.contains('modal-open')) return;
            e.preventDefault();
            
            const touches = e.touches;
            
            for (let i = 0; i < touches.length; i++) {
                const touch = touches[i];
                const touchX = touch.clientX;
                const touchY = touch.clientY;
                
                if (touchX < window.innerWidth / 2) {
                    if (leftTouchId === null) {
                        leftTouchId = touch.identifier;
                        leftStartPos = { x: touchX, y: touchY };
                        leftCurrentPos = { x: touchX, y: touchY };
                    }
                } else {
                    if (rightTouchId === null) {
                        rightTouchId = touch.identifier;
                        rightStartPos = { x: touchX, y: touchY };
                        rightCurrentPos = { x: touchX, y: touchY };
                    }
                }
            }
        }
        
        function handleTouchMove(e) {
            if (document.body.classList.contains('modal-open')) return;
            e.preventDefault();
            
            const touches = e.touches;
            
            for (let i = 0; i < touches.length; i++) {
                const touch = touches[i];
                
                if (leftTouchId === touch.identifier) {
                    leftCurrentPos = { x: touch.clientX, y: touch.clientY };
                    
                    const deltaX = (leftCurrentPos.x - leftStartPos.x) / 70;
                    const deltaY = (leftCurrentPos.y - leftStartPos.y) / 70;
                    
                    moveDirection.x = Math.max(-1, Math.min(1, deltaX));
                    moveDirection.z = Math.max(-1, Math.min(1, -deltaY));
                    
                    const knobX = 45 + deltaX * 40;
                    const knobY = 45 + deltaY * 40;
                    leftKnob.style.transform = `translate(${knobX - 45}px, ${knobY - 45}px)`;
                }
                
                if (rightTouchId === touch.identifier) {
                    const newRightPos = { x: touch.clientX, y: touch.clientY };
                    
                    const deltaX = (newRightPos.x - rightCurrentPos.x) * 0.008;
                    const deltaY = (newRightPos.y - rightCurrentPos.y) * 0.008;
                    
                    camera.rotation.y -= deltaX;
                    camera.rotation.x -= deltaY;
                    camera.rotation.x = Math.max(-Math.PI/3, Math.min(Math.PI/3, camera.rotation.x));
                    
                    const rightDeltaX = (newRightPos.x - rightStartPos.x) / 70;
                    const rightDeltaY = (newRightPos.y - rightStartPos.y) / 70;
                    const rightKnobX = 45 + Math.max(-1, Math.min(1, rightDeltaX)) * 40;
                    const rightKnobY = 45 + Math.max(-1, Math.min(1, rightDeltaY)) * 40;
                    rightKnob.style.transform = `translate(${rightKnobX - 45}px, ${rightKnobY - 45}px)`;
                    
                    rightCurrentPos = newRightPos;
                }
            }
        }
        
        function handleTouchEnd(e) {
            if (document.body.classList.contains('modal-open')) return;
            e.preventDefault();
            
            leftTouchId = null;
            rightTouchId = null;
            moveDirection.set(0, 0, 0);
            
            leftKnob.style.transform = 'translate(0px, 0px)';
            rightKnob.style.transform = 'translate(0px, 0px)';
        }
        
        // --- –°—Ç—Ä—ñ–ª—å–±–∞ ---
        function handleFireTap(e) {
            if (document.body.classList.contains('modal-open')) return;
            e.preventDefault();
            
            if (player.ammo <= 0) {
                player.ammo = 30;
                updateUI();
                return;
            }
            
            player.ammo--;
            updateUI();
            
            const bulletGeo = new THREE.SphereGeometry(0.2);
            const bulletMat = new THREE.MeshStandardMaterial({ color: 0xffaa00 });
            const bullet = new THREE.Mesh(bulletGeo, bulletMat);
            
            bullet.position.copy(camera.position);
            bullet.castShadow = true;
            scene.add(bullet);
            
            const direction = new THREE.Vector3(0, 0, -1);
            direction.applyQuaternion(camera.quaternion);
            
            bullets.push({
                mesh: bullet,
                direction: direction,
                speed: 0.8,
                distance: 0
            });
        }
        
        // --- –í–∑–∞—î–º–æ–¥—ñ—è ---
        function handleInteractTap(e) {
            if (document.body.classList.contains('modal-open')) return;
            e.preventDefault();
            e.stopPropagation();
            
            if (player.nearTrigger) {
                activeTrigger = player.nearTrigger;
                currentTaskId = activeTrigger.userData.taskId;
                
                const questions = ['2 + 2 = ?', '3 + 3 = ?', '4 + 4 = ?'];
                modalQuestion.textContent = questions[currentTaskId];
                modalAnswer.value = '';
                modalResult.textContent = '';
                
                openModal();
            } else {
                triggerIndicator.textContent = '‚ùå –ù–µ–º–∞—î —Ç—Ä–∏–≥–µ—Ä–∞ –ø–æ—Ä—É—á';
                triggerIndicator.style.background = 'rgba(255,0,0,0.8)';
                setTimeout(() => {
                    triggerIndicator.style.background = 'rgba(0,255,0,0.8)';
                    triggerIndicator.textContent = 'üëÜ –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –ó–ï–õ–ï–ù–£ –∫–Ω–æ–ø–∫—É';
                }, 1000);
            }
        }
        
        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏
        document.addEventListener('touchstart', handleTouchStart, { passive: false });
        document.addEventListener('touchmove', handleTouchMove, { passive: false });
        document.addEventListener('touchend', handleTouchEnd, { passive: false });
        document.addEventListener('touchcancel', handleTouchEnd, { passive: false });
        
        fireButton.addEventListener('touchstart', handleFireTap, { passive: false });
        interactButton.addEventListener('touchstart', handleInteractTap, { passive: false });

        // --- –û–Ω–æ–≤–ª–µ–Ω–Ω—è UI ---
        function updateUI() {
            document.getElementById('health').textContent = player.health;
            document.getElementById('score').textContent = player.score;
            document.getElementById('ammo').textContent = player.ammo;
            document.getElementById('level-display').textContent = player.level + '/3';
            
            let levelName = '';
            switch(player.level) {
                case 1: levelName = '–ú–Ü–°–¨–ö–ê –ó–ê–ë–£–î–û–í–ê'; break;
                case 2: levelName = '–õ–Ü–°–û–í–ò–ô –ú–ê–°–ò–í'; break;
                case 3: levelName = '–ì–Ü–†–°–¨–ö–ê –ú–Ü–°–¶–ï–í–Ü–°–¢–¨'; break;
            }
            document.getElementById('level-name').textContent = levelName;
        }

        // --- –Ü–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –≥—Ä–∏ (—Å–∫–æ—Ä–æ—á–µ–Ω–æ –¥–ª—è –µ–∫–æ–Ω–æ–º—ñ—ó –º—ñ—Å—Ü—è) ---
        function damagePlayer(amount) {
            player.health = Math.max(0, player.health - amount);
            updateUI();
            
            damageOverlay.style.background = 'rgba(255,0,0,0.2)';
            setTimeout(() => {
                damageOverlay.style.background = 'rgba(255,0,0,0)';
            }, 150);
            
            if (player.health <= 0) {
                player.health = 100;
                player.score = Math.max(0, player.score - 20);
                updateUI();
            }
        }

        // --- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ä—ñ–≤–Ω—è ---
        function createGround(color) {
            const geometry = new THREE.CircleGeometry(100, 64);
            const material = new THREE.MeshStandardMaterial({ color: color });
            const ground = new THREE.Mesh(geometry, material);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = 0;
            ground.receiveShadow = true;
            scene.add(ground);
        }

        function createCityLevel() {
            createGround(0x555555);
            
            // –ë—É–¥—ñ–≤–ª—ñ
            for (let i = 0; i < 15; i++) {
                const geometry = new THREE.BoxGeometry(2 + Math.random()*3, 2 + Math.random()*6, 2 + Math.random()*3);
                const material = new THREE.MeshStandardMaterial({ color: 0x888888 });
                const building = new THREE.Mesh(geometry, material);
                building.position.set((Math.random() - 0.5) * 50, geometry.parameters.height/2, (Math.random() - 0.5) * 50);
                building.castShadow = true;
                building.receiveShadow = true;
                scene.add(building);
            }
            
            // –í–æ—Ä–æ–≥–∏
            for (let i = 0; i < 4; i++) {
                const enemyGeo = new THREE.BoxGeometry(1, 2, 1);
                const enemyMat = new THREE.MeshStandardMaterial({ color: 0xff3333 });
                const enemy = new THREE.Mesh(enemyGeo, enemyMat);
                enemy.position.set((Math.random() - 0.5) * 40, 1, (Math.random() - 0.5) * 40);
                enemy.castShadow = true;
                enemy.receiveShadow = true;
                scene.add(enemy);
                
                enemies.push({
                    mesh: enemy,
                    speed: 0.02,
                    direction: new THREE.Vector3(Math.random() - 0.5, 0, Math.random() - 0.5).normalize(),
                    health: 2
                });
            }
            
            // –¢—Ä–∏–≥–µ—Ä–∏
            addTriggers();
        }

        function addTriggers() {
            const triggerMat = new THREE.MeshStandardMaterial({ 
                color: 0x00ff00, 
                transparent: true, 
                opacity: 0.4,
                emissive: 0x004400
            });
            
            const positions = [
                { x: 15, z: 10, id: 0 },
                { x: -10, z: -15, id: 1 },
                { x: 5, z: -20, id: 2 }
            ];
            
            positions.forEach(pos => {
                const triggerGeo = new THREE.BoxGeometry(4, 4, 4);
                const trigger = new THREE.Mesh(triggerGeo, triggerMat);
                trigger.position.set(pos.x, 2, pos.z);
                trigger.castShadow = true;
                trigger.receiveShadow = true;
                
                const edges = new THREE.EdgesGeometry(triggerGeo);
                const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x00ff00 }));
                trigger.add(line);
                
                trigger.userData = { type: 'task', taskId: pos.id };
                scene.add(trigger);
            });
        }

        // --- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç—Ä–∏–≥–µ—Ä—ñ–≤ ---
        function checkTriggers() {
            if (document.body.classList.contains('modal-open')) return;
            
            let foundTrigger = null;
            let minDistance = 8;
            
            scene.traverse(obj => {
                if (obj.userData && obj.userData.type === 'task') {
                    const distance = obj.position.distanceTo(camera.position);
                    if (distance < minDistance) {
                        foundTrigger = obj;
                        minDistance = distance;
                    }
                }
            });
            
            if (foundTrigger) {
                player.nearTrigger = foundTrigger;
                triggerIndicator.style.display = 'block';
            } else {
                player.nearTrigger = null;
                triggerIndicator.style.display = 'none';
            }
        }

        // --- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ---
        createCityLevel();

        // --- –ê–Ω—ñ–º–∞—Ü—ñ—è ---
        function animate() {
            requestAnimationFrame(animate);

            if (!document.body.classList.contains('modal-open')) {
                // –†—É—Ö –≥—Ä–∞–≤—Ü—è
                if (moveDirection.length() > 0.1) {
                    const speed = 0.12;
                    const move = new THREE.Vector3(moveDirection.x, 0, moveDirection.z);
                    move.applyQuaternion(camera.quaternion);
                    move.y = 0;
                    move.normalize();
                    camera.position.add(move.multiplyScalar(speed));
                }

                checkTriggers();

                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫—É–ª—å
                for (let i = bullets.length - 1; i >= 0; i--) {
                    const bullet = bullets[i];
                    bullet.mesh.position.add(bullet.direction.clone().multiplyScalar(bullet.speed));
                    bullet.distance += bullet.speed;
                    
                    for (let j = enemies.length - 1; j >= 0; j--) {
                        const enemy = enemies[j];
                        if (bullet.mesh.position.distanceTo(enemy.mesh.position) < 1.5) {
                            enemy.health--;
                            scene.remove(bullet.mesh);
                            bullets.splice(i, 1);
                            
                            if (enemy.health <= 0) {
                                scene.remove(enemy.mesh);
                                enemies.splice(j, 1);
                                player.score += 10;
                                updateUI();
                            }
                            break;
                        }
                    }
                    
                    if (bullet.distance > 50) {
                        scene.remove(bullet.mesh);
                        bullets.splice(i, 1);
                    }
                }

                // –†—É—Ö –≤–æ—Ä–æ–≥—ñ–≤
                enemies.forEach(enemy => {
                    enemy.mesh.position.add(enemy.direction.clone().multiplyScalar(enemy.speed));
                    
                    if (Math.abs(enemy.mesh.position.x) > 45) enemy.direction.x *= -1;
                    if (Math.abs(enemy.mesh.position.z) > 45) enemy.direction.z *= -1;
                    
                    if (Math.random() < 0.001 && enemy.mesh.position.distanceTo(camera.position) < 2) {
                        damagePlayer(5);
                    }
                });
            }

            renderer.render(scene, camera);
        }

        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        updateUI();

        // –ó—ñ—Ä–∫–∏
        const starsGeo = new THREE.BufferGeometry();
        const starsPos = new Float32Array(200 * 3);
        for (let i = 0; i < 200 * 3; i += 3) {
            starsPos[i] = (Math.random() - 0.5) * 200;
            starsPos[i+1] = (Math.random() - 0.5) * 200;
            starsPos[i+2] = (Math.random() - 0.5) * 200;
        }
        starsGeo.setAttribute('position', new THREE.BufferAttribute(starsPos, 3));
        const starsMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.2 });
        const stars = new THREE.Points(starsGeo, starsMat);
        scene.add(stars);
    </script>
</body>
</html>
